import java.util.*;
import javax.xml.transform.*;
import javax.xml.validation.*;
import javax.xml.transform.stream.StreamResult;
import javax.xml.transform.stream.StreamSource;
import javax.xml.transform.dom.*;
import javax.xml.transform.sax.*;
//import javax.xml.parsers.*;
import java.net.URL;
import org.xml.sax.*;
import org.xml.sax.helpers.*;
import org.w3c.dom.*;
import org.apache.xerces.jaxp.validation.*;
import org.apache.xerces.parsers.SAXParser;
import java.io.*;
import javax.jnlp.*;
 
public class SemVal
{

	private FileContents localXMLFC;
	private InputStream localXMLIS;
	private long xmlBytes;
	private String urlXSD;
    public boolean synValid=false;
    
    private Vector<String> errors;
    private Hashtable<Long,String> idType;
    private Hashtable<Long,String> idType;

        public SemVal(String localXML, String urlXSD) {
           File myfile = new File(localXML);
	   try {
	      this.xmlBytes=myfile.length();
	      this.localXMLIS=new FileInputStream(myfile);
	   }  catch (Exception e) {
                System.out.println(e.getMessage());
    		VipSemChecker.appendMessage(e.getMessage());
       }
	   this.urlXSD=urlXSD;
 	   System.out.println("Object created");
	}


        public SemVal(FileContents localXMLFC, String urlXSD)
        {
	   try{
	    this.localXMLIS=localXMLFC.getInputStream();
	    this.urlXSD=urlXSD;
  	    this.xmlBytes=localXMLFC.getLength();
 	    System.out.println("Object created");
	   } catch (Exception e) {
                System.out.println(e.getMessage());
		VipSemChecker.appendMessage(e.getMessage());
           }
	}

	public String validateSyntax() {
           XMLSchemaFactory xmlSF = new XMLSchemaFactory();
	   String lngStr="";
 	   if (xmlBytes>(1024*1024)) {
	     lngStr=Math.round(xmlBytes / (1024*1024)) + "MB";
	   } else if (xmlBytes>1024) {
	     lngStr=Math.round(xmlBytes / 1024) + "KB";
	   }else {
 	     lngStr=xmlBytes + " bytes";
	   }
	   VipSemChecker.appendMessage("Staring syntactic validation....");
	   VipSemChecker.appendMessage("Your XML file is " + lngStr + ".");
	   VipSemChecker.appendMessage("On test computers, files of size 500MB took about one minute.");
           Schema xmlS=null;
           try {
               URL schemaURL = new URL(urlXSD);
               xmlS = xmlSF.newSchema(schemaURL);
           } catch (Exception e) {
                return(e.getMessage());
           }
           Validator myval= xmlS.newValidator();

           InputSource myis = new InputSource(localXMLIS);
           SAXSource myss = new SAXSource(myis);
           
           /* Not needed, I think
           DOMSource myds=null;
           DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
           try {
           DocumentBuilder db = dbf.newDocumentBuilder();
           } catch (Exception e) {
                return(e.getMessage());
           }
           */
           
           SAXResult res=null;
           try {
                res=new SAXResult();
                //System.out.println("start");
                myval.validate(myss,res);
                synValid=true;
                return("Syntactic Validation Passed!");
           } catch (Exception e) {
                return(e.getMessage() + "\n" + res.toString());
           }
    }
        
	public String validateSemantics() {
	   //VipSemChecker.appendMessage("Staring semantic validation....");
	   //VipSemChecker.appendMessage("On test computers, files of size 500MB took about ten minutes.");

       try {

          //SAXParserFactory factory = SAXParserFactory.newInstance();
          //SAXParser saxParser = factory.newSAXParser();
          XMLReader parser = new SAXParser();

          errors=new Vector<String>();
          idType=new Hashtable<Long,String>();
          
          ContentHandler contentHandler = new VipContentHandler(this);
          //DefaultHandler dh = (DefaultHandler)contentHandler;
          parser.setContentHandler(contentHandler);
          
          parser.parse(new InputSource(localXMLIS));
          return("Semantic Validation Passed!");    
        } catch (Exception e) {
          return(e.getMessage());
        }
    }
    
    public void addIdType(Long id, String elType) {
       idType.put(id, elType);
    }
    
    public void addError(String message) {
        errors.add(message);
    }
    
    public boolean isSynValid() {
        return(synValid);
    }

    public static void main(String[] args) {
        SemVal sv = new SemVal("D:/google/spec/sample feed for v2.1.xml","file://localhost/D:/google/spec/vip_spec_v2.1.xsd");
        System.out.println(sv.validateSemantics());
    }

}
